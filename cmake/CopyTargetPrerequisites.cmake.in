include(GetPrerequisites)
set(LIB_DIRS "@CPP_OTUS_PREREQUISITES_DIRS@")
set(SKIP_PREREQUISITES_LIST "@CPP_OTUS_PREREQUISITES_EXCEPTION_NAMES@")

if (TARGET_FILE)
  get_filename_component(TARGET_PATH ${TARGET} PATH)
  get_filename_component(TARGET_NAME ${TARGET_FILE} NAME)
  set( TARGET ${TARGET_PATH}/${TARGET_NAME})
endif()

#set(TARGETS @TARGETS_LIST@)
#message(STATUS "Fixup prerequisites for: " ${TARGETS} " With dirs: " @CPP_OTUS_PREREQUISITES_DIRS@)
#foreach(TARGET ${TARGETS})
message(STATUS "Fixup prerequisites for: " ${TARGET} " With dirs: " @CPP_OTUS_PREREQUISITES_DIRS@)
  if (EXISTS ${TARGET})
    get_filename_component(TARGET_PATH ${TARGET} PATH)
    if (TARGET_SUBDIR)
      set(TARGET_PATH "${TARGET_PATH}/${TARGET_SUBDIR}")
    endif()
    get_filename_component(TARGET_NAME ${TARGET} NAME_WE)
    #message(STATUS "Fixup prerequisites for: " ${TARGET} " Path: " ${TARGET_PATH} " Name: " ${TARGET_NAME})
    get_prerequisites(${TARGET} PREREQS 1 1 "${TARGET_PATH}" "${LIB_DIRS}")

    foreach(PR ${PREREQS})
      #message(STATUS "Fixup prerequisite: " ${PR})
      GP_RESOLVE_ITEM("" ${PR} "${TARGET_PATH}" "${LIB_DIRS}" PR_PATH)
      #message(STATUS "Fixup prerequisite resoleve: " ${PR_PATH})
      if (PR_PATH)
        get_filename_component(PR_TARGET_PATH ${PR_PATH} PATH)
        get_filename_component(PR_TARGET_NAME ${PR_PATH} NAME)
        list(FIND SKIP_PREREQUISITES_LIST ${PR_PATH} SKIP_PREREQUISITES_FOUND)
        #message("Find - ${PR_PATH}  in skip list ${SKIP_PREREQUISITES_LIST} ")
        if (${SKIP_PREREQUISITES_FOUND} EQUAL -1)
          #message("${PR_TARGET_PATH}")
          if (NOT ${PR_TARGET_PATH} STREQUAL ${TARGET_PATH})
            if (NOT EXISTS ${TARGET_PATH}/${PR})
              message(STATUS "Copy ${PR_PATH} to ${TARGET_PATH}")
              execute_process(COMMAND ${CMAKE_COMMAND} -E copy_if_different "${PR_PATH}" "${TARGET_PATH}")
            endif()
          endif()
        ELSE()
          # All dependencies of skipped we must skip
          get_prerequisites(${PR_PATH} PREREQS_DEP 1 1 "${PR_TARGET_PATH}" "${LIB_DIRS}")
          #message("All dependencies of skipped we must skip- ${PR_PATH}    ${PREREQS_DEP}  ")
          foreach(PR_DEP ${PREREQS_DEP})
            GP_RESOLVE_ITEM("" ${PR_DEP} "${PR_TARGET_PATH}" "${LIB_DIRS}" PR_PATH_DEP)
            list(APPEND SKIP_PREREQUISITES_LIST "${PR_PATH_DEP}")
            #message("Skip dep - ${PR_PATH_DEP}")
          endforeach()
        endif()
      endif()
    endforeach()
  else()
    message("Not found: " ${TARGET})
  endif()
#endforeach()
